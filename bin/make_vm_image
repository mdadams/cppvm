#! /usr/bin/env bash

panic()
{
	echo "error: $@"
	exit 1
}

get_time()
{
	date +"%Y-%m-%d %H:%M:%S"
}

vm_get_state()
{

	local name="$1"
	local buffer
	# Note: Do not put local on the next line as this changes the exit status.
	buffer=$(virsh dominfo "$name" 2> /dev/null) || return 1
	local state=$(sed -n -e 's/^State:[ ]*\(.*\)$/\1/p' <<< "$buffer")
	case "$state" in
	"shut off")
		echo "shut_off";;
	running)
		echo "running";;
	"in shutdown")
		echo "in_shutdown";;
	paused)
		echo "paused";;
	*)
		echo "unknown ($state)";;
	esac
}

vm_wait_for_shutoff()
{
	local name="$1"
	echo "waiting for shutoff"
	while true; do
		state=$(vm_get_state "$name") || return 1
		if [ "$state" = shut_off ]; then
			break
		fi
		sleep 30
	done
	echo "finished wait for shutoff"
	return 0
}

get_checksum()
{
	local file="$1"
	sha512sum - < "$file" | awk '{print $1;}' -
}

usage()
{
	cat <<- EOF
	Usage:
	$0 -d work_dir -n vm_name -k ks_file -r sde_version

	Examples:
	$0 -n f29_sde_4_0_28 -r 4.0.28 -k data/f29_minimal_xfce_sde.ks -d workdir
	EOF
	exit 2
}

cmd_dir=$(dirname "$0") || panic "cannot get program directory"
root_dir="$cmd_dir/.."
data_dir="$root_dir/data"

tmp_dir=/var/tmp
debug_level=0
sparsify=1
ks_file=
work_dir=
name=
mirror=muug
sde_version=
vmdi_dir=/var/lib/libvirt/images

while getopts D:d:n:k:t:m:xz:r: opt; do
	case "$opt" in
	d)
		work_dir="$OPTARG";;
	n)
		name="$OPTARG";;
	k)
		ks_file="$OPTARG";;
	D)
		debug_level="$OPTARG";;
	t)
		tmp_dir="$OPTARG";;
	m)
		mirror="$OPTARG";;
	x)
		sparsify=0;;
	z)
		vmdi_dir="$OPTARG";;
	r)
		sde_version="$OPTARG";;
	\?)
		usage
		break;;
	esac
done
shift $((OPTIND - 1))

if [ "$debug_level" -ge 1 ]; then
	set -xv
fi

if [ -z "$sde_version" ]; then
	usage "no SDE version specified"
fi
if [ -z "$work_dir" ]; then
	usage "no work directory specified"
fi
work_dir=$(realpath "$work_dir") || panic "cannot get realpath"
if [ -z "$name" ]; then
	usage "no VM name specified"
fi
if [ -z "$ks_file" ]; then
	usage "no kickstart file specified"
fi
ks_file=$(realpath "$ks_file") || panic "cannot get realpath"

if [ ! -f "$ks_file" ]; then
	panic "kickstart file is missing"
fi

if [ -z "$tmp_dir" ]; then
	tmp_dir="${TMPDIR:-/tmp}"
fi

case "$mirror" in
muug)
	netinst_url="https://muug.ca/mirror/fedora/linux/releases/29/Everything/x86_64/iso/Fedora-Everything-netinst-x86_64-29-1.2.iso"
	;;
*)
	netinst_url="https://download.fedoraproject.org/pub/fedora/linux/releases/29/Everything/x86_64/iso/Fedora-Everything-netinst-x86_64-29-1.2.iso"
	;;
esac

cat <<- EOF
work directory: $work_dir
kickstart file: $ks_file
VM name: $name
temporary directory: $tmp_dir
sparsify: $sparsify
mirror: $mirror
netinst URL: $netinst_url
EOF

#exit

download_dir="$work_dir/downloads"
image_dir="$work_dir/images"

netinst_base=$(basename "$netinst_url") || panic "cannot get base name"
netinst_file="$download_dir/$netinst_base"

disk_file="$vmdi_dir/$name.qcow2"
orig_file="$image_dir/$name-original.qcow2"
orig_csum_file="$orig_file-SHA512SUM"
qcow2_file="$image_dir/$name.qcow2"
gzip_qcow2_file="$qcow2_file.gz"
vmdk_file="$image_dir/$name.vmdk"
gzip_vmdk_file="$vmdk_file.gz"
vdi_file="$image_dir/$name.vdi"
gzip_vdi_file="$vdi_file.gz"
csum_file="$image_dir/SHA512SUM"

ks_base=$(basename "$ks_file") || \
  panic "cannot get base name"

for dir in "$work_dir" "$download_dir" "$image_dir"; do
	if [ ! -d "$dir" ]; then
		mkdir "$dir" || panic "cannot make directory $dir"
		chmod a+rx "$dir"
	fi
done

echo "START TIME: $(get_time)"

ls -l "$download_dir"
ls -l "$image_dir"

if [ ! -f "$netinst_file" ]; then
	wget -O "$netinst_file" "$netinst_url" || \
	  panic "cannot download netinst"
fi

if [ ! -f "$disk_file" ]; then
	for file in "$orig_file" "$orig_csum_file"; do
		if [ -f "$file" ]; then
			rm -f "$file" || panic "cannot remove file $file"
		fi
	done
	virt-install \
	  --name "$name" \
	  --memory 16384 \
	  --vcpus 4 \
	  --disk path=$disk_file,format=qcow2,size=16 \
	  --os-type linux \
	  --network bridge=virbr0 \
	  --graphics spice \
	  --location "$netinst_file" \
	  --initrd-inject "$ks_file" \
	  --extra-args "ks=file:/$ks_base" \
	  --extra-args "MVMDI_SDE_VERSION=$sde_version" \
	  --extra-args "MVMDI_SDE_INSTALL_DIR=/opt/sde" \
	  --events on_poweroff=preserve \
	  || panic "virt-install failed"
	vm_wait_for_shutoff "$name" || panic "wait for VM shut off failed"
	echo "INSTALL FINISHED: $(get_time)"
fi

if [ ! -f "$disk_file" ]; then
	panic "disk image missing"
fi

clean=1
if [ "$clean" -ne 0 ]; then
	for file in "$orig_file" "$qcow2_file" "$gzip_qcow2_file" "$vdi_file" \
	  "$gzip_vdi_file" "$vmdk_file" "$gzip_vmdk_file" "$csum_file"; do
		if [ -f "$file" ]; then
			rm -f "$file" || panic "cannot remove file $file"
		fi
	done
	ls -al "$image_dir"
fi

if [ ! -f "$orig_file" ]; then
	echo "copying created disk image"
	cp "$disk_file" "$orig_file" || panic "cannot copy file"
	chmod a-w "$orig_file" || panic "cannot change file permissions"
	echo "COPY FINISHED: $(get_time)"
	get_checksum "$orig_file" > "$orig_csum_file" || \
	  panic "cannot make checksum file"
fi

if [ ! -f "$orig_file" ]; then
	panic "missing file $orig_file"
fi

vm_wait_for_shutoff "$name" || panic "wait for VM shut off failed"
echo "WAIT FINISHED: $(get_time)"

ls -l "$image_dir"

if [ ! -f "$qcow2_file" ]; then
	echo "Making sparse QCOW2 image"
	if [ "$sparsify" -ne 0 ]; then
		TMPDIR="$tmp_dir" \
		  virt-sparsify "$orig_file" "$qcow2_file" || \
		  panic "cannot sparsify VM image"
	else
		cp "$orig_file" "$qcow2_file" || \
		  panic "cannot copy file"
	fi
	ls -l "$qcow2_file"
fi

if [ ! -f "$gzip_vdi_file" ]; then
	echo "Converting from QCOW2 to VDI"
	qemu-img convert -f qcow2 -O vdi \
	  "$qcow2_file" "$vdi_file" || \
	  panic "cannot convert image"
	ls -l "$vdi_file"
	echo "Compressing VDI image"
	gzip "$vdi_file" || panic "cannot compress image"
	ls -l "$gzip_vdi_file"
fi

if [ ! -f "$gzip_vmdk_file" ]; then
	echo "Converting from QCOW2 to VMDK"
	qemu-img convert -f qcow2 -O vmdk \
	  -o adapter_type=lsilogic,subformat=streamOptimized,compat6 \
	  "$qcow2_file" "$vmdk_file" || \
	  panic "cannot convert image"
	ls -l "$vmdk_file"
	echo "Compressing VMDK image"
	gzip "$vmdk_file" || panic "cannot compress image"
	ls -l "$gzip_vmdk_file"
fi

if [ ! -f "$gzip_qcow2_file" ]; then
	echo "Compressing QCOW2 image"
	gzip "$qcow2_file" || panic "cannot compress image"
	ls -l "$gzip_qcow2_file"
fi

echo "List files"
ls -l "$image_dir"

args=()
for file in "$orig_file" "$qcow2_file" "$gzip_qcow2_file" \
  "$vdi_file" "$gzip_vdi_file" "$vmdk_file" "$gzip_vmdk_file"; do
	if [ -f "$file" ]; then
		args+=($(basename "$file")) || panic
	fi
done

(cd "$image_dir" && sha512sum "${args[@]}") > "$csum_file" || \
  panic "cannot generate checksum file"

echo "FINISHED: $(get_time)"

cleanup=1
if [ "$cleanup" -ne 0 ]; then
	state=$(vm_get_state "$name") || panic "cannot get VM state"
	if [ "$state" != shut_off ]; then
		virsh destroy "$name" || \
		  panic "cannot shut off VM"
	fi
	virsh undefine "$name" || \
	  panic "virsh undefine failed"
	virsh vol-delete --pool default "$name.qcow2" || \
	  panic "virsh vol-delete failed"
fi

exit

##########
  --cdrom "$netinst_file" \

